<UserControl x:Class="ManagementFile.App.Views.Project.ProjectManagentsDragablzView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:dragablz="clr-namespace:Dragablz;assembly=Dragablz"
             xmlns:local="clr-namespace:ManagementFile.App.Views.Project"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <!-- Context Menu for Tabs -->
        <ContextMenu x:Key="TabContextMenu" Style="{StaticResource TabContextMenuStyle}">
            <MenuItem Header="📌 Ghim tab" 
                      Command="{Binding PinTabCommand}"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
            <MenuItem Header="🔄 Làm mới" 
                      IsEnabled="False"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
            <Separator/>
            <MenuItem Header="❌ Đóng tab" 
                      Command="{Binding CloseTabCommand}"
                      InputGestureText="Ctrl+W"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
            <MenuItem Header="❌ Đóng các tab khác" 
                      Command="{Binding DataContext.CloseOtherTabsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
            <MenuItem Header="❌ Đóng tabs bên phải" 
                      Command="{Binding DataContext.CloseTabsToRightCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
            <Separator/>
            <MenuItem Header="❌ Đóng tất cả tabs" 
                      Command="{Binding DataContext.CloseAllTabsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      InputGestureText="Ctrl+Shift+W"
                      Style="{StaticResource TabContextMenuItemStyle}"/>
        </ContextMenu>
    </UserControl.Resources>

    <Grid Background="{StaticResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ==================== HEADER TOOLBAR ==================== -->
        <Border Grid.Row="0" 
                Background="White"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Effect="{StaticResource DropShadowEffect}">
            <Grid Margin="10,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Title & Icon -->
                <StackPanel Grid.Column="0" 
                           Orientation="Horizontal"
                           VerticalAlignment="Center">
                    <Border Background="{StaticResource PrimaryBrush}"
                            Width="25"
                            Height="25"
                            CornerRadius="5"
                            Margin="0,0,8,0">
                        <TextBlock Text="📑" 
                                   FontSize="12" 
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="Quản lý dự án" 
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="#333"/>
                        <TextBlock Text="Hệ thống quản lý tabs đa nhiệm" 
                                   FontSize="12"
                                   Foreground="#999"/>
                    </StackPanel>
                </StackPanel>

                <!-- Right: Actions & Info -->
                <StackPanel Grid.Column="2" 
                           Orientation="Horizontal"
                           HorizontalAlignment="Right"
                           VerticalAlignment="Center">

                    <!-- Tab Count Badge -->
                    <Border Style="{StaticResource BadgeStyle}"
                            Background="#E3F2FD">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📊" 
                                       FontSize="12"
                                       Margin="0,0,4,0"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding TabCountInfo}" 
                                       Style="{StaticResource BadgeTextStyle}"
                                       Foreground="{StaticResource PrimaryBrush}"/>
                        </StackPanel>
                    </Border>

                    <!-- Separator -->
                    <Separator Style="{StaticResource ToolbarSeparatorStyle}"/>
                    
                    <!-- Close All Button -->
                    <Button Content="❌ Đóng tất cả"
                            Command="{Binding CloseAllTabsCommand}"
                            Style="{StaticResource DangerButtonStyle}"
                            FontSize="12"
                            Margin="5,0"
                            ToolTip="Đóng tất cả tabs (Ctrl+Shift+W)"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ==================== DRAGABLZ TAB CONTROL ==================== -->
        <dragablz:TabablzControl Grid.Row="1"
                                ItemsSource="{Binding Tabs}"
                                SelectedItem="{Binding SelectedTab, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                HeaderItemTemplate="{StaticResource TabHeaderTemplate}"
                                ContentTemplate="{StaticResource TabContentTemplate}"
                                Margin="10,10,10,0"
                                ShowDefaultCloseButton="False"
                                Background="Transparent"
                                BorderThickness="0"
                                x:Name="MainTabControl" 
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Stretch">

            <!-- InterTabController for drag & drop between windows -->
            <dragablz:TabablzControl.InterTabController>
                <dragablz:InterTabController 
                    InterTabClient="{Binding InterTabClient}"
                    Partition="ProjectManagementTabs"/>
            </dragablz:TabablzControl.InterTabController>

            <!-- Custom Tab Item Container Style -->
            <dragablz:TabablzControl.CustomHeaderItemStyle>
                <Style TargetType="{x:Type dragablz:DragablzItem}" 
                       BasedOn="{StaticResource CustomDragablzItemStyle}">
                    <Setter Property="ContextMenu" Value="{StaticResource TabContextMenu}"/>
                </Style>
            </dragablz:TabablzControl.CustomHeaderItemStyle>

            <!-- Custom Tab Strip -->
            <dragablz:TabablzControl.HeaderPrefixContent>
                <Border Background="Transparent" 
                        Width="10"/>
            </dragablz:TabablzControl.HeaderPrefixContent>

            <dragablz:TabablzControl.HeaderSuffixContent>
                <Border Background="Transparent" 
                        Width="10"/>
            </dragablz:TabablzControl.HeaderSuffixContent>


        </dragablz:TabablzControl>

        <!-- ==================== STATUS BAR ==================== -->
        <Border Grid.Row="2" 
                Background="White"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Current Tab Info -->
                <StackPanel Grid.Column="0" 
                           Orientation="Horizontal"
                           VerticalAlignment="Center">
                    <TextBlock Text="📌" 
                               FontSize="12"
                               Margin="0,0,6,0"
                               VerticalAlignment="Center"/>
                    <TextBlock FontSize="12"
                               Foreground="#666"
                               VerticalAlignment="Center">
                        <Run Text="Tab hiện tại:"/>
                        <Run Text="{Binding SelectedTab.Title, FallbackValue='Không có'}" 
                             FontWeight="SemiBold"
                             Foreground="#333"/>
                    </TextBlock>

                    <TextBlock Text="|" 
                               Margin="12,0"
                               Foreground="#DDD"
                               FontSize="12"
                               VerticalAlignment="Center"/>

                    <TextBlock FontSize="12"
                               Foreground="#666"
                               VerticalAlignment="Center">
                        <Run Text="Tạo lúc:"/>
                        <Run Text="{Binding SelectedTab.CreatedTime, StringFormat='{}{0:HH:mm:ss dd/MM/yyyy}', FallbackValue='--'}"
                             Foreground="#999"/>
                    </TextBlock>

                    <!-- Modified Indicator -->
                    <Border Background="#FFEBEE"
                            CornerRadius="3"
                            Padding="6,2"
                            Margin="12,0,0,0"
                            Visibility="{Binding SelectedTab.IsModified, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="● Chưa lưu"
                                   FontSize="10"
                                   Foreground="#F44336"
                                   FontWeight="SemiBold"/>
                    </Border>

                    <!-- Pinned Indicator -->
                    <Border Background="#FFF3E0"
                            CornerRadius="3"
                            Padding="6,2"
                            Margin="6,0,0,0"
                            Visibility="{Binding SelectedTab.IsPinned, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="📌 Đã ghim"
                                   FontSize="10"
                                   Foreground="#FF9800"
                                   FontWeight="SemiBold"/>
                    </Border>
                </StackPanel>

                <!-- Right: Tips & Shortcuts -->
                <!--<StackPanel Grid.Column="1" 
                           Orientation="Horizontal"
                           VerticalAlignment="Center">
                    <TextBlock Text="💡" 
                               FontSize="12"
                               Margin="0,0,6,0"
                               VerticalAlignment="Center"/>
                    <TextBlock FontSize="11"
                               Foreground="#999"
                               FontStyle="Italic"
                               VerticalAlignment="Center">
                        <Run Text="Kéo tab để tạo cửa sổ mới"/>
                        <Run Text="●" Foreground="#DDD"/>
                        <Run Text="Chuột phải để xem thêm"/>
                    </TextBlock>
                </StackPanel>-->
            </Grid>
        </Border>

        <!-- ==================== LOADING OVERLAY (Optional) ==================== -->
        <Border Grid.RowSpan="3"
                Background="#80000000"
                Visibility="Collapsed"
                x:Name="LoadingOverlay">
            <StackPanel HorizontalAlignment="Center"
                       VerticalAlignment="Center">
                <Border Background="White"
                        CornerRadius="8"
                        Padding="30,20"
                        Effect="{StaticResource DropShadowEffect}">
                    <StackPanel>
                        <TextBlock Text="⏳"
                                   FontSize="48"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,10"/>
                        <TextBlock Text="Đang tải..."
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="#333"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
