<Window x:Class="ManagementFile.App.Views.Project.AddEditTaskDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:ManagementFile.App.Controls"
        Title="{Binding DialogTitle}" 
        Height="950" Width="1300"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        MinHeight="800" MinWidth="1100"
        Background="#F8F9FA"
        WindowStyle="SingleBorderWindow">

    <Window.Resources>

        <Style x:Key="ModernDatePicker" TargetType="DatePicker">
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#2C3E50"/>
            <Setter Property="MinHeight" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DatePicker">
                        <Border Name="Border"
            Background="{TemplateBinding Background}"
            BorderBrush="{TemplateBinding BorderBrush}"
            BorderThickness="{TemplateBinding BorderThickness}"
            CornerRadius="8"
            Padding="{TemplateBinding Padding}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- DatePicker TextBox -->
                                <DatePickerTextBox Grid.Column="0"
                               x:Name="PART_TextBox"
                               Foreground="{TemplateBinding Foreground}"
                               Background="Transparent"
                               BorderThickness="0"
                               Padding="0"
                               VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                               HorizontalContentAlignment="Left"/>

                                <!-- Calendar Button -->
                                <Button Grid.Column="1"
                    x:Name="PART_Button"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="8,0"
                    VerticalAlignment="Stretch">
                                    <Path Data="M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"
                      Fill="#7F8C8D"
                      Width="16"
                      Height="16"
                      Stretch="Uniform"/>
                                </Button>

                                <!-- Popup for Calendar -->
                                <Popup Grid.Column="0"
                   x:Name="PART_Popup"
                   StaysOpen="False"
                   PlacementTarget="{Binding ElementName=Border}"
                   Placement="Bottom"
                   AllowsTransparency="True">
                                    <Border Background="White"
                        BorderBrush="#BDC3C7"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="4"
                        Effect="{StaticResource DropShadowEffect}">
                                        <Calendar x:Name="PART_Calendar"/>
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="#3498DB"/>
                                <Setter TargetName="Border" Property="BorderThickness" Value="2"/>
                                <Setter TargetName="Border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#3498DB" Opacity="0.3" ShadowDepth="0" BlurRadius="8"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="#3498DB"/>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Border" Property="Background" Value="#F8F9FA"/>
                                <Setter Property="Foreground" Value="#7F8C8D"/>
                                <Setter TargetName="Border" Property="BorderBrush" Value="#E8E8E8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsViewMode}" Value="True">
                    <Setter Property="IsEnabled" Value="False"/>
                    <Setter Property="Background" Value="#F5F5F5"/>
                    <Setter Property="BorderBrush" Value="#E0E0E0"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <Grid Margin="25">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Border Grid.Row="0" Style="{StaticResource CardStyle}">
            <StackPanel>
                <TextBlock Text="{Binding DialogTitle}" 
                           FontSize="20" 
                           FontWeight="Bold" 
                           Foreground="#2C3E50"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,10"/>
                <!--<TextBlock Text="{Binding ParentTaskTitle}" 
                           FontSize="16" 
                           FontWeight="Bold" 
                           Foreground="#2C3E50"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,10"
                           Visibility="{Binding HasParentTaskId, Converter={StaticResource BooleanToVisibilityConverter}}"/>-->
                <TextBlock Text="Các trường có dấu (*) là bắt buộc." 
                           Style="{StaticResource FieldLabel}"
                           FontSize="12"
                           Margin="0"
                           Foreground="#7F8C8D"
                           FontStyle="Italic"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content - Scrollable -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto" 
                      HorizontalScrollBarVisibility="Disabled"
                      PanningMode="VerticalOnly"
                      Background="Transparent"
                      Margin="0,20,0,0">
            
            <StackPanel Margin="0,0,10,0">
                <!-- Basic Task Information Section - Collapsible -->
                <Expander Style="{StaticResource ModernExpander}" IsExpanded="True">
                    <Expander.Header>
                        <TextBlock Text="📋 Thông tin cơ bản" 
                                   FontSize="16" 
                                   FontWeight="Bold" 
                                   Foreground="#2C3E50"/>
                    </Expander.Header>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Task Title -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,20">
                            <TextBlock Style="{StaticResource FieldLabel}">
                                <Run Text="Tiêu đề công việc "/>
                                <Run Text="*" Foreground="#E74C3C" FontWeight="Bold"/>
                            </TextBlock>
                            <TextBox Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource ModernTextBox}"
                                     ToolTip="Tên mô tả ngắn gọn về công việc"
                                     MaxLength="200"/>
                        </StackPanel>

                        <!-- Task Type -->
                        <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,0,20">
                            <TextBlock Text="Loại công việc" Style="{StaticResource FieldLabel}"/>
                            <ComboBox ItemsSource="{Binding TaskTypeItems}"
                                      SelectedValue="{Binding TaskType, UpdateSourceTrigger=PropertyChanged}"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValuePath="Value"
                                      Style="{StaticResource ModernComboBox}"
                                      ToolTip="Phân loại công việc"/>
                        </StackPanel>

                        <!-- Priority -->
                        <StackPanel Grid.Row="1" Grid.Column="2" Margin="0,0,0,20">
                            <TextBlock Text="Độ ưu tiên" Style="{StaticResource FieldLabel}"/>
                            <ComboBox ItemsSource="{Binding PriorityItems}"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValuePath="Value"
                                      SelectedValue="{Binding Priority, UpdateSourceTrigger=PropertyChanged}" 
                                      Style="{StaticResource ModernComboBox}"
                                      ToolTip="Mức độ ưu tiên của công việc"/>
                        </StackPanel>

                        <!-- Description -->
                        <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,20">
                            <TextBlock Text="Mô tả chi tiết" Style="{StaticResource FieldLabel}"/>

                            <StackPanel Visibility="{Binding IsViewMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                <TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" 
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         MinHeight="100"
                                         VerticalContentAlignment="Top"
                                         Style="{StaticResource ModernTextBox}"
                                         ToolTip="Mô tả chi tiết về yêu cầu và tiêu chí hoàn thiện"
                                         MaxLength="5000"/>
                                <TextBlock Text="{Binding Description, Converter={StaticResource LengthToCountConverter}, ConverterParameter=5000}"
                                           FontSize="11"
                                           Foreground="#7F8C8D"
                                           FontStyle="Italic"
                                           HorizontalAlignment="Right"
                                           Margin="0,6,6,0"/>
                            </StackPanel>

                            <StackPanel Visibility="{Binding IsViewMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <controls:PathLinkUserControl x:Name="DescriptionPathLinkViewer"
                                                              TextDescription="{Binding Description}"/> 
                            </StackPanel>
                            
                        </StackPanel>

                        <!-- Status (conditional) -->
                        <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,0,0,20" 
                                    Visibility="{Binding IsNewTask, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                            <TextBlock Text="Trạng thái" Style="{StaticResource FieldLabel}"/>
                            <ComboBox ItemsSource="{Binding StatusItems}"
                                      SelectedValuePath="Value"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValue="{Binding Status, UpdateSourceTrigger=PropertyChanged}"
                                      Style="{StaticResource ModernComboBox}"/>
                        </StackPanel>
                    </Grid>
                </Expander>

                <!-- Assignment & Timeline Section - Collapsible -->
                <Expander Style="{StaticResource ModernExpander}" IsExpanded="True">
                    <Expander.Header>
                        <TextBlock Text="👤 Phân công và thời gian" FontSize="16" FontWeight="Bold" Foreground="#2C3E50"/>
                    </Expander.Header>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Assigned To -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,20">
                            <TextBlock Style="{StaticResource FieldLabel}">
                                <Run Text="Người thực hiện"/>
                                <Run Text="*" Foreground="#E74C3C" FontWeight="Bold"/>
                            </TextBlock>

                            <controls:UserSelectorControl x:Name="AssignedSelector"
                                                        SelectedUser="{Binding SelectedAssignedToUser, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        SearchScope="{Binding AssignedToUserScope}"
                                                        ProjectId="{Binding ProjectId}"
                                                        Placeholder="{Binding AssignedToUserPlaceholder}"
                                                        IsReadOnly="{Binding IsViewMode}"/>
                        </StackPanel>

                        <!-- Reporter -->
                        <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,0,20">
                            <TextBlock Style="{StaticResource FieldLabel}">
                                <Run Text="Người báo cáo"/>
                                <Run Text="*" Foreground="#E74C3C" FontWeight="Bold"/>
                            </TextBlock>

                            <controls:UserSelectorControl x:Name="ReportSelector"
                                                        SelectedUser="{Binding SelectedReporterUser, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        SearchScope="{Binding ReporterUserScope}"
                                                        ProjectId="{Binding ProjectId}"
                                                        Placeholder="{Binding ReporterUserPlaceholder}"
                                                        IsReadOnly="{Binding IsViewMode}"/>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,20">
                            <TextBlock Text="Thêm người thực hiện" Style="{StaticResource FieldLabel}"/>
                            
                            <controls:MultiUserSelectorControl x:Name="MentionedUsersSelector"
                                                               SelectedUsers="{Binding AssignedUsers, Mode=TwoWay}"
                                                               ProjectId="{Binding ProjectId}"
                                                               SearchScope="{Binding AssignedsToUserScope}"
                                                               Placeholder="{Binding AssignedsUserPlaceholder}"
                                                               IsReadOnly="{Binding IsViewMode}"/>

                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,20">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Dates -->
                                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,20">
                                    <TextBlock Text="Ngày bắt đầu" Style="{StaticResource FieldLabel}"/>
                                    <DatePicker SelectedDate="{Binding StartDate, UpdateSourceTrigger=PropertyChanged}" 
                                                ToolTip="Ngày dự kiến bắt đầu"
                                                Style="{StaticResource ModernDatePicker}"/>
                                </StackPanel>

                                <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,0,20">
                                    <TextBlock Text="Dự kiến hoàn thành" Style="{StaticResource FieldLabel}"/>
                                    <DatePicker SelectedDate="{Binding DueDate, UpdateSourceTrigger=PropertyChanged}" 
                                                ToolTip="Chọn ngày dự kiến hoàn thành công việc"
                                                Style="{StaticResource ModernDatePicker}"/>
                                </StackPanel>

                                <StackPanel Grid.Row="0" Grid.Column="5" Margin="0,0,0,20">
                                    <TextBlock Text="Ngày hoàn thành công việc" Style="{StaticResource FieldLabel}"/>
                                    <DatePicker SelectedDate="{Binding CompletedAt, UpdateSourceTrigger=PropertyChanged}" 
                                                ToolTip="Ngày hoàn thành công việc"
                                                Style="{StaticResource ModernDatePicker}"/>
                                </StackPanel>


                                <!-- Hours -->
                                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,0,20">
                                    <TextBlock Text="Số giờ ước tính (h)" Style="{StaticResource FieldLabel}"/>
                                    <TextBox Text="{Binding EstimatedHours, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource ModernTextBox}"
                                             ToolTip="Số giờ dự kiến hoàn thành công việc"/>
                                </StackPanel>

                                <StackPanel Grid.Row="1" Grid.Column="2" Margin="0,0,0,20">
                                      <TextBlock Text="Số giờ thực tế (h)" Style="{StaticResource FieldLabel}"/>
                                      <TextBox Text="{Binding ActualHours, UpdateSourceTrigger=PropertyChanged}" 
                                               Style="{StaticResource ModernTextBox}"
                                               ToolTip="Số giờ đã làm thực tế"
                                               IsReadOnly="True"/>
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="5" Margin="0,0,0,20" >
                                    <TextBlock Text="Tiến độ công việc (%)" Style="{StaticResource FieldLabel}"/>
                                    <TextBox Text="{Binding Progress, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource ModernTextBox}"
                                             ToolTip="Tiến độ công việc, tính theo (%)"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                        
                    </Grid>
                </Expander>

                <!-- Additional Settings Section -->
                <Expander Style="{StaticResource ModernExpander}" IsExpanded="False">
                    <Expander.Header>
                        <TextBlock Text="⚙️ Cài đặt bổ sung" FontSize="16" FontWeight="Bold" Foreground="#2C3E50"/>
                    </Expander.Header>
                    <StackPanel>

                        <Grid>
                            <!--Tags with TagInputControl-->
                            <StackPanel>
                                <TextBlock Text="Tags/Từ khóa" Style="{StaticResource FieldLabel}"/>

                                <!--Edit Mode-->
                                <controls:TagInputControl x:Name="TagInputControl"
                                              Tags="{Binding Tags, Mode=TwoWay}"
                                              IsReadOnly="{Binding IsViewMode}"
                                              Placeholder="Nhập tag và nhấn Enter để thêm..."
                                              MaxTags="50"
                                              AllowDuplicates="False"/>
                            </StackPanel>

                        </Grid>
                    </StackPanel>
                </Expander>

            </StackPanel>
        </ScrollViewer>

        <!-- Bottom Section - Status Left, Actions Right -->
        <Border Grid.Row="2" Style="{StaticResource CardStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Task Status - Bottom Left -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center" Margin="0,0,10,0">
                    <StackPanel>

                        <!-- Validation Message -->
                        <TextBlock Text="{Binding ValidationMessage}" 
                                   Style="{StaticResource FieldLabel}"
                                   Foreground="#E74C3C" 
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"
                                   Margin="0,10,0,0"
                                   Visibility="{Binding HasValidationMessage, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <StackPanel Orientation="Horizontal"
                                VerticalAlignment="Center"
                                Margin="0,0,20,0"
                                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <ProgressBar IsIndeterminate="True"
                                     Width="120"
                                     Height="6"
                                     Foreground="#3498DB"
                                     Background="#ECF0F1"
                                     BorderThickness="0"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" 
                                    VerticalAlignment="Center"
                                    Margin="0,0,20,0"
                                    Visibility="{Binding IsViewMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="✏️ Chỉnh sửa" 
                                    Command="{Binding EditCommand}" 
                                    Style="{StaticResource EditButton}"
                                    ToolTip="Chuyển sang chế độ chỉnh sửa (F2)"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" 
                                    VerticalAlignment="Center"
                                    Margin="0,0,20,0"
                                    Visibility="{Binding IsEditNewMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="💾 Lưu" 
                                    Command="{Binding SaveCommand}" 
                                    Style="{StaticResource PrimaryButton}"
                                    ToolTip="Lưu thay đổi (Ctrl+S)"/>
                        </StackPanel>
                        <StackPanel Margin="0,0,20,0"
                                    Visibility="{Binding IsEditMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="🔄 Reset" 
                                    Command="{Binding RefreshCommand}" 
                                    Style="{StaticResource SecondaryButton}"
                                    ToolTip="Khôi phục giá trị ban đầu (F5)"/>
                        </StackPanel>

                        <Button Content="❌ Hủy" 
                                Command="{Binding CancelCommand}" 
                                Style="{StaticResource SecondaryButton}"
                                ToolTip="Đóng dialog (Esc)"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
        
    </Grid>

    <!-- Keyboard Shortcuts -->
    <Window.InputBindings>
        <KeyBinding Command="{Binding SaveCommand}" Key="S" Modifiers="Ctrl"/>
        <KeyBinding Command="{Binding EditCommand}" Key="F2"/>
        <KeyBinding Command="{Binding CancelCommand}" Key="Escape"/>
        <KeyBinding Command="{Binding RefreshCommand}" Key="F5"/>
    </Window.InputBindings>
</Window>