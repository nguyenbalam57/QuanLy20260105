<UserControl x:Class="ManagementFile.App.Views.TimeLogs.WeeklyTimesheetView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ManagementFile.App.Views.TimeLogs"
             xmlns:conv="clr-namespace:ManagementFile.App.Converters"
             xmlns:beh="clr-namespace:ManagementFile.App.Behaviors"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1500">
    <UserControl.Resources>
         
         <!--Styles-->
        
    </UserControl.Resources>

    <Grid Background="White">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!--Header-->
            <RowDefinition Height="Auto"/>
            <!--Week Navigation-->
            <RowDefinition Height="Auto"/>
            <!--Add Task-->
            <RowDefinition Height="*"/>
            <!--Timesheet Grid-->
            <RowDefinition Height="Auto"/>
            <!--Daily Totals-->
            <RowDefinition Height="Auto"/>
            <!--Buttons-->
        </Grid.RowDefinitions>

        <!-- ✅ HEADER - Soft Blue -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBlue}" Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Background="White" CornerRadius="4" Padding="8,4" Margin="0,0,12,0">
                        <TextBlock Text="📊" FontSize="20"/>
                    </Border>
                    <TextBlock Text="TIMESHEET TUẦN" 
                               FontSize="18" 
                               FontWeight="SemiBold" 
                               Foreground="White"
                               VerticalAlignment="Center"/>
                    <Border Background="#3A7BC8" CornerRadius="12" Padding="12,4" Margin="12,0,0,0">
                        <TextBlock Text="{Binding WeekNumber, StringFormat='Tuần {0}'}" 
                                   FontSize="13" 
                                   Foreground="White"
                                   VerticalAlignment="Center"/>
                    </Border>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="Đã tải 2 task" 
                               FontSize="12" 
                               Foreground="White"
                               Opacity="0.9"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0"/>
                    <TextBlock Text="{Binding StatusMessage}" 
                               FontSize="13" 
                               FontWeight="Medium"
                               Foreground="White"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ✅ WEEK NAVIGATION - Clean Design -->
        <Border Grid.Row="1" Background="White" Padding="24,16" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" 
                        Command="{Binding PreviousWeekCommand}"
                        Style="{StaticResource SecondaryButton}"
                        Content="← Tuần trước"
                        Width="120"/>

                <StackPanel Grid.Column="1" 
                           Orientation="Horizontal" 
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center">
                    <Border Background="{StaticResource LightBlue}" 
                            CornerRadius="8" 
                            Padding="16,8">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📅" FontSize="16" Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding WeekDisplay}" 
                                       FontSize="15" 
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource DarkText}"/>
                        </StackPanel>
                    </Border>

                    <Button Command="{Binding CurrentWeekCommand}"
                            Style="{StaticResource PrimaryButtonTime}"
                            Content="Hôm nay"
                            Width="100"
                            Margin="12,0,0,0"/>
                </StackPanel>

                <Button Grid.Column="2" 
                        Command="{Binding NextWeekCommand}"
                        Style="{StaticResource SecondaryButtonTime}"
                        Content="Tuần sau →"
                        Width="120"/>
            </Grid>
        </Border>

        <!--Add Task Row-->
        <Border Grid.Row="2" 
                Background="{StaticResource LightGray}" 
                Padding="24,12" 
                BorderBrush="{StaticResource BorderColor}" 
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                          Text="+ Thêm task:" 
                          FontSize="13"
                          FontWeight="Medium"
                          Foreground="{StaticResource DarkText}"
                          VerticalAlignment="Center"
                          Margin="0,0,12,0"/>

                <ComboBox Grid.Column="1"
                          Style="{StaticResource ModernComboBox}"
                          ItemsSource="{Binding AvailableTasks}"
                          SelectedItem="{Binding SelectedTaskToAdd}"
                          DisplayMemberPath="DisplayTextForTimeTracking"/>

                <Button Grid.Column="2" 
                        Content="✔️ Thêm" 
                        Command="{Binding AddTaskCommand}"
                        Style="{StaticResource SuccessButtonStyle}"/>

                <Button Grid.Column="3" 
                        Content="📋 Copy tuần trước" 
                        Command="{Binding CopyPreviousWeekCommand}"
                        Style="{StaticResource ActionButtonStyle}"/>
            </Grid>
        </Border>


        <!-- ✅ TIMESHEET GRID - Clean Table -->
        <ScrollViewer Grid.Row="3" 
                     VerticalScrollBarVisibility="Auto" 
                     HorizontalScrollBarVisibility="Auto"
                     Background="White"
                     Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Headers -->
                    <RowDefinition Height="*"/>
                    <!-- Rows -->
                </Grid.RowDefinitions>

                <!-- HEADERS -->
                <Border Grid.Row="0" 
                       Background="{StaticResource LightGray}" 
                       CornerRadius="8,8,0,0"
                       BorderBrush="{StaticResource BorderColor}"
                       BorderThickness="1,1,1,0">
                    <Grid Height="48">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition MinWidth="280"/>
                            <!-- Task -->
                            <ColumnDefinition Width="90"/>
                            <!-- Mon -->
                            <ColumnDefinition Width="90"/>
                            <!-- Tue -->
                            <ColumnDefinition Width="90"/>
                            <!-- Wed -->
                            <ColumnDefinition Width="90"/>
                            <!-- Thu -->
                            <ColumnDefinition Width="90"/>
                            <!-- Fri -->
                            <ColumnDefinition Width="90"/>
                            <!-- Sat -->
                            <ColumnDefinition Width="90"/>
                            <!-- Sun -->
                            <ColumnDefinition Width="100"/>
                            <!-- Total -->
                            <ColumnDefinition Width="50"/>
                            <!-- Actions -->
                        </Grid.ColumnDefinitions>

                        <!-- Task Header -->
                        <TextBlock Grid.Column="0" 
                                  Text="📋 TASK / NGÀY" 
                                  Style="{StaticResource ModernHeaderText}"
                                  HorizontalAlignment="Left"
                                  Margin="16,0"/>

                        <!-- Day Headers -->
                        <TextBlock Grid.Column="1" Text="{Binding DayHeaders[0]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center"/>
                        <TextBlock Grid.Column="2" Text="{Binding DayHeaders[1]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center"/>
                        <TextBlock Grid.Column="3" Text="{Binding DayHeaders[2]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="{Binding DayHeaders[3]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center"/>
                        <TextBlock Grid.Column="5" Text="{Binding DayHeaders[4]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center"/>
                        <TextBlock Grid.Column="6" Text="{Binding DayHeaders[5]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center" Foreground="{StaticResource SoftGray}"/>
                        <TextBlock Grid.Column="7" Text="{Binding DayHeaders[6]}" Style="{StaticResource ModernHeaderText}" TextAlignment="Center" Foreground="{StaticResource SoftGray}"/>
                        <TextBlock Grid.Column="8" Text="⏱️ TỔNG" Style="{StaticResource ModernHeaderText}" Foreground="{StaticResource SoftOrange}"/>
                        <TextBlock Grid.Column="9" Text="⚙️" Style="{StaticResource ModernHeaderText}"/>
                    </Grid>
                </Border>

                <!-- DATA ROWS -->
                <ItemsControl Grid.Row="1" ItemsSource="{Binding Entries}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="White"
                                   BorderBrush="{StaticResource BorderColor}"
                                   BorderThickness="1,0,1,1"
                                   Padding="0">
                                <Grid Height="56">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition MinWidth="280"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="90"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Task Name -->
                                        <Border Grid.Column="0" Background="#FAFBFC" Padding="16,0" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <StackPanel VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Title}" 
                                                      FontSize="13"
                                                      FontWeight="Medium"
                                                      Foreground="{StaticResource DarkText}"
                                                      TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding TaskCode}" 
                                                      FontSize="11"
                                                      Foreground="{StaticResource SoftGray}"
                                                      Margin="0,2,0,0"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Hours Cells -->
                                        <Border Grid.Column="1" Background="{Binding Hours0, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours0, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}"/>
                                        </Border>
                                        <Border Grid.Column="2" Background="{Binding Hours1, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours1, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}"/>
                                        </Border>
                                        <Border Grid.Column="3" Background="{Binding Hours2, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}"/>
                                        </Border>
                                        <Border Grid.Column="4" Background="{Binding Hours3, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours3, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}"/>
                                        </Border>
                                        <Border Grid.Column="5" Background="{Binding Hours4, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours4, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}"/>
                                        </Border>
                                        <Border Grid.Column="6" Background="{Binding Hours5, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours5, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}" Foreground="{StaticResource SoftGray}"/>
                                        </Border>
                                        <Border Grid.Column="7" Background="{Binding Hours6, Converter={StaticResource HoursToColorConverter}}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBox Text="{Binding Hours6, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource SoftCellTextBox}" Foreground="{StaticResource SoftGray}"/>
                                        </Border>

                                        <!-- Total -->
                                        <Border Grid.Column="8" Background="{StaticResource LightOrange}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,1,0">
                                            <TextBlock Text="{Binding TotalHours, StringFormat='{}{0:F1}h'}" 
                                                  FontSize="14"
                                                  FontWeight="Bold"
                                                  Foreground="{StaticResource SoftOrange}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                        </Border>

                                        <!-- Delete -->
                                        <Border Grid.Column="9">
                                            <Button Command="{Binding DataContext.RemoveTaskCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                               CommandParameter="{Binding}"
                                               Background="Transparent"
                                               BorderThickness="0"
                                               Width="32" Height="32"
                                               Cursor="Hand"
                                               ToolTip="Xóa task">
                                                <TextBlock Text="🗑️" FontSize="14"/>
                                            </Button>
                                        </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </ScrollViewer>

        <!-- ✅ DAILY TOTALS -->
        <Border Grid.Row="4" Background="{StaticResource LightGray}" Padding="16,12" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition MinWidth="280"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="50"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                          Text="⏱️ TỔNG MỖI NGÀY" 
                          FontSize="13"
                          FontWeight="SemiBold"
                          Foreground="{StaticResource DarkText}"
                          VerticalAlignment="Center"
                          Margin="16,0"/>

                    <TextBlock Grid.Column="1" Text="{Binding DailyTotal0, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="2" Text="{Binding DailyTotal1, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="3" Text="{Binding DailyTotal2, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="4" Text="{Binding DailyTotal3, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="5" Text="{Binding DailyTotal4, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="6" Text="{Binding DailyTotal5, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource SoftGray}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="7" Text="{Binding DailyTotal6, StringFormat='{}{0:F1}h'}" FontSize="13" FontWeight="Bold" Foreground="{StaticResource SoftGray}" HorizontalAlignment="Center" VerticalAlignment="Center"/>

                    <Border Grid.Column="8" Background="{StaticResource SoftOrange}" CornerRadius="6" Padding="12,6">
                        <TextBlock Text="{Binding WeekTotalHours, StringFormat='{}{0:F1}h'}" 
                              FontSize="15"
                              FontWeight="Bold"
                              Foreground="White"
                              HorizontalAlignment="Center"/>
                    </Border>
            </Grid>
        </Border>


        <!--Validation Messages-->
        <Border Grid.Row="4" 
                Background="#FFF3CD" 
                BorderBrush="#FFC107" 
                BorderThickness="0,2,0,0"
                Padding="15,10"
                Visibility="{Binding ValidationMessages.Count, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="⚠️ CẢNH BÁO và GỢI Ý:" 
                           FontWeight="Bold"
                           FontSize="14"
                           Margin="0,0,0,5"/>
                <ItemsControl ItemsSource="{Binding ValidationMessages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" 
                                       Margin="10,2"
                                       FontSize="12"
                                       TextWrapping="Wrap"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- ✅ ACTION BUTTONS -->
        <Border Grid.Row="5" Background="White" Padding="24,16" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Command="{Binding SaveCommand}"
                       Style="{StaticResource PrimaryButton}"
                       Width="140"
                        ToolTip="Lưu (Ctrl + S)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="💾" FontSize="14" Margin="0,0,6,0"/>
                        <TextBlock Text="Lưu"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding RefreshCommand}"
                       Style="{StaticResource SecondaryButton}"
                       Width="150"
                       ToolTip="Làm mới (F5)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🔄" FontSize="14" Margin="0,0,6,0"/>
                        <TextBlock Text="Làm mới"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="6" 
              Background="#80FFFFFF"
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <Border Background="White" 
                    Width="200" Height="120"
                    CornerRadius="12"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <!-- ✅ Inline Effect -->
                <Border.Effect>
                    <DropShadowEffect Color="#000000" 
                             Direction="270" 
                             ShadowDepth="4" 
                             BlurRadius="12" 
                             Opacity="0.15"/>
                </Border.Effect>
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="⏳" FontSize="40" HorizontalAlignment="Center"/>
                    <TextBlock Text="Đang xử lý..." 
                              FontSize="14"
                              FontWeight="Medium"
                              Foreground="{StaticResource DarkText}"
                              Margin="0,12,0,0"
                              HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>

    </Grid>

    <!-- ✅ KeyBindings for shortcuts -->
    <UserControl.InputBindings>
        <!-- Ctrl+S: Save -->
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveCommand}"/>

        <!-- F5 hoặc Ctrl+R: Refresh -->
        <KeyBinding Key="F5" Command="{Binding RefreshCommand}"/>
        <KeyBinding Key="R" Modifiers="Control" Command="{Binding RefreshCommand}"/>

        <!-- Ctrl+N: Add Task -->
        <KeyBinding Key="N" Modifiers="Control" Command="{Binding AddTaskCommand}"/>

        <!-- Ctrl+Left: Previous Week -->
        <KeyBinding Key="Left" Modifiers="Control" Command="{Binding PreviousWeekCommand}"/>

        <!-- Ctrl+Right: Next Week -->
        <KeyBinding Key="Right" Modifiers="Control" Command="{Binding NextWeekCommand}"/>

        <!-- Ctrl+Home: Current Week -->
        <KeyBinding Key="Home" Modifiers="Control" Command="{Binding CurrentWeekCommand}"/>

        <!-- Ctrl+C: Copy Previous Week -->
        <KeyBinding Key="C" Modifiers="Control+Shift" Command="{Binding CopyPreviousWeekCommand}"/>
    </UserControl.InputBindings>
</UserControl>
